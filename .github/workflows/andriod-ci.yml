name: Android CI — Build, Test, Sign & Upload Artifacts

# -----------------------------------------------------------
# Trigger workflow only when code is pushed to master.
# You can add: pull_request, tags, releases, schedules, etc.
# -----------------------------------------------------------
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [staging, main]

# -----------------------------------------------------------
# Avoid duplicate runs when multiple pushes happen quickly.
# Ensures only the latest run executes.
# -----------------------------------------------------------
concurrency:
  group: android-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:

  # ===========================================================
  # 1) UNIT TEST JOB
  # ===========================================================
  unit-test:
    name: Run Android Unit Tests
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------
      # Step 1 — Checkout the repository files.
      # --------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # Step 2 — Install Java 17 (modern default for Android).
      # setup-java@v4 automatically caches Gradle if enabled.
      # --------------------------------------------------------
      - name: Set Up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      # --------------------------------------------------------
      # Step 3 — Cache Gradle dependencies to speed up builds.
      # This avoids redownloading libs every workflow run.
      # --------------------------------------------------------
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      # --------------------------------------------------------
      # Step 4 — Give Gradle wrapper executable permission.
      # --------------------------------------------------------
      - name: Grant Execute Permission to gradlew
        run: chmod +x gradlew

      # --------------------------------------------------------
      # Step 5 — Run Unit Tests for Debug variant.
      # Errors will cause CI to fail immediately.
      # --------------------------------------------------------
      - name: Run Unit Tests
        run: ./gradlew testDebugUnitTest --stacktrace
        
      # --------------------------------------------------------
      # Step 6 — Run Lint checks.
      # --------------------------------------------------------
      - name: Run Lint
        run: ./gradlew lint --stacktrace

      # --------------------------------------------------------
      # Step 7 — Generate coverage reports.
      # --------------------------------------------------------
      - name: Generate Coverage Report
        run: ./gradlew jacocoTestDebugUnitTestReport --stacktrace

      # --------------------------------------------------------
      # Step 8 — Upload coverage to Codecov.
      # --------------------------------------------------------
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./app/build/reports/jacoco/jacocoTestDebugUnitTestReport/jacocoTestDebugUnitTestReport.xml
          flags: android
          fail_ci_if_error: false


  # ===========================================================
  # 2) BUILD + SIGN + UPLOAD ARTIFACTS
  # ===========================================================
  build:
    name: Build, Sign & Upload (APK + AAB)
    runs-on: ubuntu-latest
    needs: unit-test    # Run only after tests pass

    steps:

      # --------------------------------------------------------
      # Step 1 — Checkout codebase.
      # --------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # Step 2 — Install Java 17 for Android builds.
      # Gradle caching improves performance significantly.
      # --------------------------------------------------------
      - name: Set Up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      # --------------------------------------------------------
      # Step 3 — Cache Gradle wrapper + dependencies.
      # This cuts build time drastically.
      # --------------------------------------------------------
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
            ~/.gradle/caches
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      # --------------------------------------------------------
      # Step 4 — Ensure gradlew is executable.
      # --------------------------------------------------------
      - name: Grant Execute Permission
        run: chmod +x gradlew

      # --------------------------------------------------------
      # Step 5 — Compile both artifacts:
      #   - assembleRelease => Release APK
      #   - bundleRelease   => Release AAB
      #
      # Produces: 
      #   app/build/outputs/apk/release/*.apk
      #   app/build/outputs/bundle/release/*.aab
      # --------------------------------------------------------
      - name: Build APK & AAB (Release)
        run: ./gradlew assembleRelease bundleRelease --stacktrace

      # --------------------------------------------------------
      # Step 6 — Sign the Release APK & AAB using a keystore.
      #
      # r0adkll/sign-android-release automatically:
      #  - extracts keystore (Base64 -> .jks)
      #  - signs AAB + APK
      #  - outputs paths to signed artifacts
      #
      # releaseDirectory: You give it the parent folder and it
      # detects the APK & AAB inside automatically.
      # --------------------------------------------------------
      - name: Sign All Release Artifacts (APK + AAB)
        id: sign_app
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: app/build/outputs/
          signingKeyBase64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          alias: ${{ secrets.KEY_ALIAS }}
          keyStorePassword: ${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}

      # --------------------------------------------------------
      # Step 7 — Upload Signed AAB as a downloadable artifact.
      # Users can download via GitHub Actions → Artifacts.
      # --------------------------------------------------------
      - name: Upload Signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: signed-release-aab
          path: ${{ steps.sign_app.outputs.signedReleaseBundle }}

      # --------------------------------------------------------
      # Step 8 — Upload Signed APK as a downloadable artifact.
      # --------------------------------------------------------
      - name: Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: signed-release-apk
          path: ${{ steps.sign_app.outputs.signedReleaseApk }}
