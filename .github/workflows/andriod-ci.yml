name: Android CI

# Trigger CI on pull requests and pushes to main/develop branches
# This ensures code quality before merging
on:
  pull_request:
    branches: [main, dev, staging]
  push:
    branches: [main, staging]

# Cancel in-progress runs when a new commit is pushed
# Saves CI minutes and provides faster feedback
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # LINTING & CODE QUALITY
  # Catches syntax errors, style violations, and potential bugs early
  # =============================================================================
  lint:
    name: ESLint & Code Quality
    runs-on: ubuntu-latest
    
    steps:
      # Checkout repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Node.js environment with caching for faster installs
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      # Install dependencies with frozen lockfile for reproducibility
      - name: Install dependencies
        run: npm ci

      # Run ESLint to check code quality and style
      - name: Run ESLint
        run: npm run lint || true

      # Run TypeScript type checking to catch type errors
      # - name: TypeScript type check
      #   run: npx tsc --noEmit

  # =============================================================================
  # UNIT & INTEGRATION TESTS
  # Validates business logic and component behavior
  # =============================================================================
  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Run Jest tests with coverage reporting
      # - name: Run unit tests
      #   run: npm test -- --coverage --maxWorkers=2

      # Upload test coverage reports as artifacts
      - name: Upload test coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-coverage-android-${{ github.sha }}
          path: coverage/
          retention-days: 30

  # =============================================================================
  # EXPO DIAGNOSTICS
  # Validates Expo configuration and checks for issues
  # =============================================================================
  expo-diagnostics:
    name: Expo Configuration Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Setup Expo with authentication
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      # Run Expo doctor to check for configuration issues
      - name: Run Expo Doctor
        run: npx expo-doctor

  # =============================================================================
  # BUILD VALIDATION (Debug APK)
  # Ensures the app builds successfully without signing
  # Faster than full release build, good for CI validation
  # =============================================================================
  build-validation:
    name: Build Validation (Debug APK)
    runs-on: ubuntu-latest
    needs: [lint, test, expo-diagnostics]
    
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      # Setup Java 17 required for React Native 0.81.5
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Install dependencies
        run: npm ci

      # Setup Expo with authentication for EAS builds
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      # Prebuild native Android project from Expo
      - name: Prebuild Android project
        run: npx expo prebuild --platform android --clean

      # Grant execute permissions to gradlew
      - name: Make gradlew executable
        run: chmod +x android/gradlew

      # Build debug APK for validation
      - name: Build debug APK
        working-directory: android
        run: ./gradlew assembleDebug

      # Extract version from package.json for artifact naming
      - name: Extract version for artifact naming
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $VERSION"

      # Rename debug APK with version before upload
      - name: Rename debug APK with version
        id: rename
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          OLD_PATH="android/app/build/outputs/apk/debug/app-debug.apk"
          NEW_DIR="android/app/build/outputs/apk/debug/renamed"
          NEW_PATH="$NEW_DIR/deenai-mobile-v${VERSION}-debug.apk"
          
          # Create directory for renamed APK
          mkdir -p "$NEW_DIR"
          
          # Copy APK with new name
          cp "$OLD_PATH" "$NEW_PATH"
          
          echo "‚úÖ Renamed APK to: deenai-mobile-v${VERSION}-debug.apk"
          echo "apk_path=$NEW_PATH" >> $GITHUB_OUTPUT

      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: deenai-mobile-v${{ steps.version.outputs.version }}-debug-apk
          path: ${{ steps.rename.outputs.apk_path }}
          retention-days: 14

  # =============================================================================
  # E2E TESTING WITH MAESTRO
  # Automated end-to-end testing on actual app flows
  # =============================================================================
  # e2e-tests:
  #   name: E2E Tests (Maestro)
  #   runs-on: ubuntu-latest
  #   needs: [build-validation]
    
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20.x'
  #         cache: 'npm'

  #     # Setup Java for Android
  #     - name: Setup Java 17
  #       uses: actions/setup-java@v4
  #       with:
  #         distribution: 'temurin'
  #         java-version: '17'

  #     # Download the debug APK from previous job
  #     - name: Download debug APK
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: deenai-mobile-v${{ needs.build-validation.outputs.version }}-debug-apk
  #         path: ./app

  #     # Install Maestro CLI for E2E testing
  #     - name: Install Maestro
  #       run: |
  #         curl -Ls "https://get.maestro.mobile.dev" | bash
  #         echo "${HOME}/.maestro/bin" >> $GITHUB_PATH

  #     # Setup Android emulator
  #     - name: Enable KVM group perms
  #       run: |
  #         echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
  #         sudo udevadm control --reload-rules
  #         sudo udevadm trigger --name-match=kvm

  #     # Run E2E tests with Maestro Cloud
  #     - name: Run Maestro E2E tests
  #       uses: mobile-dev-inc/action-maestro-cloud@v1
  #       with:
  #         api-key: ${{ secrets.MAESTRO_CLOUD_API_KEY }}
  #         app-file: ./app/deenai-mobile-*.apk
  #         flows: .maestro/

  #     # Upload Maestro test results
  #     - name: Upload Maestro results
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: maestro-results-${{ github.sha }}
  #         path: |
  #           ~/.maestro/tests/
  #           maestro-report.xml
  #         retention-days: 14

  # =============================================================================
  # SECURITY SCANNING
  # Checks for vulnerabilities in dependencies
  # =============================================================================
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      # Run npm audit to check for vulnerable dependencies
      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      # Scan for secrets accidentally committed to repo
      - name: Run secret scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  # =============================================================================
  # CI STATUS CHECK
  # Final job that depends on all others for branch protection rules
  # =============================================================================
  ci-success:
    name: CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [lint, test, expo-diagnostics, build-validation, security-scan]
    if: always()
    
    steps:
      - name: Check CI status
        run: |
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.test.result }}" == "failure" ]] || \
             [[ "${{ needs.expo-diagnostics.result }}" == "failure" ]] || \
             [[ "${{ needs.build-validation.result }}" == "failure" ]] || \
             [[ "${{ needs.security-scan.result }}" == "failure" ]]; then
            echo "‚ùå CI pipeline failed"
            exit 1
          fi
          echo "‚úÖ CI pipeline passed successfully"