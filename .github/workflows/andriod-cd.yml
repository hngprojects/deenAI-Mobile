name: Android CD (Continuous Deployment)

# Trigger CD only on version tags and manual workflow dispatch
# This ensures controlled releases with proper versioning
on:
  push:
    tags:
      - 'v*.*.*'  # Matches v1.0.0, v2.1.3, etc.
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - production
          - staging
          - internal
        default: 'production'

# Prevent concurrent deployments to avoid conflicts
concurrency:
  group: android-cd-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # =============================================================================
  # PRE-DEPLOYMENT VALIDATION
  # Runs all CI checks before building release artifacts
  # =============================================================================
  pre-deployment-checks:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper versioning

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Run linting to ensure code quality
      - name: Run ESLint
        run: npm run lint

      # Run TypeScript type checking
      - name: TypeScript type check
        run: npx tsc --noEmit

      # Run tests to ensure functionality
      - name: Run tests
        run: npm test

      # Extract version information from tag or package.json
      - name: Extract version information
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          BUILD_NUMBER=${{ github.run_number }}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Deploying version: $VERSION (Build: $BUILD_NUMBER)"

  # =============================================================================
  # BUILD SIGNED APK
  # Creates signed APK for direct distribution (sideloading, testing, etc.)
  # APK is universal but larger in size than AAB
  # =============================================================================
  build-apk:
    name: Build Signed APK
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      # Setup Java 17 for React Native 0.81.5
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Install dependencies
        run: npm ci

      # Setup Expo with authentication
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      # Prebuild native Android project with version info
      - name: Prebuild Android project
        run: |
          npx expo prebuild --platform android --clean
        env:
          EXPO_PUBLIC_VERSION: ${{ needs.pre-deployment-checks.outputs.version }}

      # Decode and setup keystore for signing
      # Keystore must be base64 encoded and stored in secrets
      - name: Setup Android keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.keystore

      # Create keystore.properties file for Gradle
      - name: Create keystore properties
        run: |
          cat > android/keystore.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=release.keystore
          EOF

      # Update gradle.properties with version information
      - name: Update version in gradle
        run: |
          cat >> android/gradle.properties << EOF
          VERSION_NAME=${{ needs.pre-deployment-checks.outputs.version }}
          VERSION_CODE=${{ needs.pre-deployment-checks.outputs.build_number }}
          EOF

      # Grant execute permissions to gradlew
      - name: Make gradlew executable
        run: chmod +x android/gradlew

      # Build signed release APK
      - name: Build release APK
        working-directory: android
        run: ./gradlew assembleRelease

      # Verify APK was created and is signed
      - name: Verify APK signature
        run: |
          APK_PATH="android/app/build/outputs/apk/release/app-release.apk"
          if [ ! -f "$APK_PATH" ]; then
            echo "âŒ APK not found at $APK_PATH"
            exit 1
          fi
          # Check APK signature using apksigner
          $ANDROID_HOME/build-tools/*/apksigner verify --verbose "$APK_PATH"

      # Rename APK with version information
      - name: Rename APK with version
        run: |
          VERSION=${{ needs.pre-deployment-checks.outputs.version }}
          BUILD=${{ needs.pre-deployment-checks.outputs.build_number }}
          mv android/app/build/outputs/apk/release/app-release.apk \
             android/app/build/outputs/apk/release/deenai-mobile-v${VERSION}.apk

      # Upload signed APK as downloadable artifact
      - name: Upload signed APK
        uses: actions/upload-artifact@v4
        with:
          name: deenai-mobile-v${{ needs.pre-deployment-checks.outputs.version }}-apk
          path: android/app/build/outputs/apk/release/deenai-mobile-*.apk
          retention-days: 90  # Keep for 90 days

      # Clean up sensitive files
      - name: Cleanup keystore
        if: always()
        run: |
          rm -f android/app/release.keystore
          rm -f android/keystore.properties

  # =============================================================================
  # BUILD SIGNED AAB (Android App Bundle)
  # Creates signed AAB for Google Play Store distribution
  # AAB is optimized and required for Play Store uploads
  # =============================================================================
  build-aab:
    name: Build Signed AAB
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Prebuild Android project
        run: |
          npx expo prebuild --platform android --clean
        env:
          EXPO_PUBLIC_VERSION: ${{ needs.pre-deployment-checks.outputs.version }}

      # Setup keystore for AAB signing
      - name: Setup Android keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.keystore

      - name: Create keystore properties
        run: |
          cat > android/keystore.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=release.keystore
          EOF

      - name: Update version in gradle
        run: |
          cat >> android/gradle.properties << EOF
          VERSION_NAME=${{ needs.pre-deployment-checks.outputs.version }}
          VERSION_CODE=${{ needs.pre-deployment-checks.outputs.build_number }}
          EOF

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      # Build signed release AAB (Android App Bundle)
      - name: Build release AAB
        working-directory: android
        run: ./gradlew bundleRelease

      # Verify AAB was created and is properly signed
      - name: Verify AAB
        run: |
          AAB_PATH="android/app/build/outputs/bundle/release/app-release.aab"
          if [ ! -f "$AAB_PATH" ]; then
            echo "âŒ AAB not found at $AAB_PATH"
            exit 1
          fi
          # Check file size (AAB should be reasonable size)
          SIZE=$(stat -c%s "$AAB_PATH")
          echo "AAB size: $SIZE bytes"
          if [ "$SIZE" -lt 1000000 ]; then
            echo "Warning: AAB seems too small"
          fi

      # Rename AAB with version information
      - name: Rename AAB with version
        run: |
          VERSION=${{ needs.pre-deployment-checks.outputs.version }}
          BUILD=${{ needs.pre-deployment-checks.outputs.build_number }}
          mv android/app/build/outputs/bundle/release/app-release.aab \
             android/app/build/outputs/bundle/release/deenai-mobile-v${VERSION}.aab

      # Upload signed AAB as downloadable artifact
      - name: Upload signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: deenai-mobile-v${{ needs.pre-deployment-checks.outputs.version }}-aab
          path: android/app/build/outputs/bundle/release/deenai-mobile-*.aab
          retention-days: 90

      # Generate and upload mapping file for crash reporting
      # Proguard mapping file is essential for deobfuscating crash reports
      - name: Upload ProGuard mapping file
        uses: actions/upload-artifact@v4
        with:
          name: mapping-v${{ needs.pre-deployment-checks.outputs.version }}
          path: android/app/build/outputs/mapping/release/mapping.txt
          retention-days: 365  # Keep mapping files for 1 year

      # Clean up sensitive files
      - name: Cleanup keystore
        if: always()
        run: |
          rm -f android/app/release.keystore
          rm -f android/keystore.properties

  # =============================================================================
  # E2E TESTING ON RELEASE BUILD
  # Tests the actual signed release APK before distribution
  # =============================================================================
  e2e-release-tests:
    name: E2E Tests on Release APK
    runs-on: ubuntu-latest
    needs: [build-apk, pre-deployment-checks]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Download the signed release APK
      - name: Download release APK
        uses: actions/download-artifact@v4
        with:
          name: deenai-mobile-v${{ needs.pre-deployment-checks.outputs.version }}-apk
          path: ./app

      # Install Maestro for E2E testing
      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "${HOME}/.maestro/bin" >> $GITHUB_PATH

      # Run critical E2E smoke tests on release build
      - name: Run E2E smoke tests
        uses: mobile-dev-inc/action-maestro-cloud@v1
        with:
          api-key: ${{ secrets.MAESTRO_CLOUD_API_KEY }}
          project-id: ${{ secrets.MAESTRO_PROJECT_ID }}
          app-file: ./app/deenai-mobile-*.apk

      # Upload test results
      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-release-results
          path: ~/.maestro/tests/
          retention-days: 30

  # =============================================================================
  # CREATE GITHUB RELEASE
  # Creates a GitHub release with APK and AAB as downloadable assets
  # =============================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, build-apk, build-aab]
    if: startsWith(github.ref, 'refs/tags/')
    
    permissions:
      contents: write  # Required to create releases
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Download APK artifact
      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: deenai-mobile-v${{ needs.pre-deployment-checks.outputs.version }}-apk
          path: ./artifacts/apk

      # Download AAB artifact
      - name: Download AAB
        uses: actions/download-artifact@v4
        with:
          name: deenai-mobile-v${{ needs.pre-deployment-checks.outputs.version }}-aab
          path: ./artifacts/aab

      # Download ProGuard mapping file
      - name: Download mapping file
        uses: actions/download-artifact@v4
        with:
          name: mapping-v${{ needs.pre-deployment-checks.outputs.version }}
          path: ./artifacts/mapping

      # Generate release notes from commits
      - name: Generate release notes
        id: release_notes
        run: |
          VERSION=${{ needs.pre-deployment-checks.outputs.version }}
          BUILD=${{ needs.pre-deployment-checks.outputs.build_number }}
          
          cat > release_notes.md << EOF
          # DeenAI Mobile v${VERSION} (Build ${BUILD})
          
          ## ðŸ“¦ Downloads
          - **APK**: For direct installation and testing
          - **AAB**: For Google Play Store upload
          - **Mapping**: ProGuard mapping file for crash analysis
          
          ## ðŸ”§ Build Information
          - Version: ${VERSION}
          - Build Number: ${BUILD}
          - Commit: ${GITHUB_SHA:0:7}
          - Built: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ## ðŸ“ Changes
          $(git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD || echo "- Initial release")
          
          ## âš™ï¸ Technical Details
          - React Native: 0.81.5
          - Expo SDK: ~54.0.23
          - Minimum SDK: Check app-level build.gradle
          
          ---
          **Installation Instructions for APK:**
          1. Enable "Install from Unknown Sources" on your Android device
          2. Download the APK file
          3. Open and install the APK
          EOF
          
          echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT

      # Create GitHub release with artifacts
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: DeenAI Mobile v${{ needs.pre-deployment-checks.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          files: |
            ./artifacts/apk/*.apk
            ./artifacts/aab/*.aab
            ./artifacts/mapping/mapping.txt
          token: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # DEPLOY TO GOOGLE PLAY STORE (INTERNAL TRACK)
  # Automatically uploads AAB to Play Store Internal Testing track
  # Uncomment when ready for Play Store distribution
  # =============================================================================
  # deploy-play-store:
  #   runs-on: ubuntu-latest
  #   needs: [pre-deployment-checks, build-aab]
  #   if: github.event.inputs.release_type == 'production' || github.event.inputs.release_type == 'staging'
    
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  
  #     # Download the signed AAB
  #     - name: Download AAB
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: deenai-mobile-v${{ needs.pre-deployment-checks.outputs.version }}-aab
  #         path: ./artifacts/aab
  
  #     # Upload to Google Play Store
  #     # Requires service account JSON in secrets
  #     - name: Upload to Play Store
  #       uses: r0adkll/upload-google-play@v1
  #       with:
  #         serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
  #         packageName: com.deenai.mobile  # Replace with your package name
  #         releaseFiles: ./artifacts/aab/*.aab
  #         track: ${{ github.event.inputs.release_type == 'production' && 'production' || github.event.inputs.release_type == 'staging' && 'beta' || 'internal' }}
  #         status: ${{ github.event.inputs.release_type == 'production' && 'completed' || 'draft' }}
  #         inAppUpdatePriority: 2
  #         whatsNewDirectory: ./whatsnew/  # Optional: Release notes per language

  # =============================================================================
  # NOTIFY DEPLOYMENT
  # Sends deployment notifications to Slack
  # =============================================================================
  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, build-apk, build-aab, create-release]
    if: always()
    
    steps:
      # Send Slack notification (uncomment and configure when ready)
      # - name: Send Slack notification
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
      #     webhook-type: incoming-webhook
      #     payload: |
      #       {
      #         "text": "ðŸš€ DeenAI Mobile Deployment",
      #         "blocks": [
      #           {
      #             "type": "section",
      #             "text": {
      #               "type": "mrkdwn",
      #               "text": "*DeenAI Mobile v${{ needs.pre-deployment-checks.outputs.version }}* has been deployed!\n*Status:* ${{ needs.create-release.result }}\n*Build:* #${{ needs.pre-deployment-checks.outputs.build_number }}"
      #             }
      #           }
      #         ]
      #       }

      - name: Deployment summary
        run: |
          echo "ðŸŽ‰ Deployment completed for v${{ needs.pre-deployment-checks.outputs.version }}"
          echo "ðŸ“¦ APK and AAB artifacts are available for download"
          echo "ðŸ”— Check the Releases page for download links"