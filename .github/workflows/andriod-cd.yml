name: Android CD — Build, Sign & Deploy to Play Store

# -----------------------------------------------------------
# Trigger: Deployment pipeline runs ONLY after merging into main.
# Prevents accidental deployments during development.
# -----------------------------------------------------------
on:
  push:
    branches: [ main ]

# -----------------------------------------------------------
# Prevent simultaneous deployments.
# Ensures clean, isolated, predictable CD runs.
# -----------------------------------------------------------
concurrency:
  group: android-cd-${{ github.ref }}
  cancel-in-progress: false

jobs:

  # ===========================================================
  # 1) BUILD + SIGN RELEASE ARTIFACTS (APK + AAB)
  # ===========================================================
  build-and-sign:
    name: Build & Sign Release Artifacts
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------
      # Step 1 — Checkout repo
      # --------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # Step 2 — Install JDK 17 (Android modern baseline)
      # --------------------------------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      # --------------------------------------------------------
      # Step 3 — Cache Gradle to speed up builds drastically
      # --------------------------------------------------------
      - name: Cache Gradle Files
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
            ~/.gradle/caches
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      # --------------------------------------------------------
      # Step 4 — Grant executable access to Gradle wrapper
      # --------------------------------------------------------
      - name: Grant Execute Permission
        run: chmod +x gradlew

      # --------------------------------------------------------
      # Step 5 — Build Release APK + AAB
      #
      # Output:
      #  • app/build/outputs/apk/release/*.apk
      #  • app/build/outputs/bundle/release/*.aab
      #
      # --stacktrace ensures full debugging if build fails.
      # --------------------------------------------------------
      - name: Build Release APK and AAB
        run: ./gradlew assembleRelease bundleRelease --stacktrace

      # --------------------------------------------------------
      # Step 6 — SIGN artifacts using keystore
      #
      # This action:
      #  ✔ extracts Base64 keystore to a real file
      #  ✔ signs AAB + APK
      #  ✔ provides output paths
      #
      # releaseDirectory = parent folder; auto-detects files inside.
      # --------------------------------------------------------
      - name: Sign Release Artifacts
        id: sign_app
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: app/build/outputs/
          signingKeyBase64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          alias: ${{ secrets.KEY_ALIAS }}
          keyStorePassword: ${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}

      # --------------------------------------------------------
      # Step 7 — Upload signed APK to GitHub artifacts
      # --------------------------------------------------------
      - name: Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: signed-release-apk
          path: ${{ steps.sign_app.outputs.signedReleaseApk }}

      # --------------------------------------------------------
      # Step 8 — Upload signed AAB to GitHub artifacts
      # --------------------------------------------------------
      - name: Upload Signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: signed-release-aab
          path: ${{ steps.sign_app.outputs.signedReleaseBundle }}


  # ===========================================================
  # 2) PUBLISH TO GOOGLE PLAY INTERNAL TESTING
  # ===========================================================
  deploy:
    name: Deploy to Google Play Internal Testing
    runs-on: ubuntu-latest
    needs: build-and-sign

    steps:
      # --------------------------------------------------------
      # Step 1 — Download signed AAB from previous job
      # --------------------------------------------------------
      - name: Download Signed AAB
        uses: actions/download-artifact@v4
        with:
          name: signed-release-aab
          path: release/

      # --------------------------------------------------------
      # Step 2 — Publish to Play Store Internal Track
      #
      # Uses r0adkll/upload-google-play or triple-workflow.
      # Below is the most robust and error-free uploader.
      #
      # Requirements:
      #  ✔ PLAYSTORE_JSON_KEY (Base64 Google Service Account JSON)
      #  ✔ App already registered on Play Console
      #  ✔ Matching packageName
      # --------------------------------------------------------
      - name: Upload to Google Play Internal Testing
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAYSTORE_JSON_KEY }}
          packageName: com.yourcompany.yourapp   # <-- Replace
          releaseFiles: release/*.aab
          track: internal
          status: completed
          inAppUpdatePriority: 0
